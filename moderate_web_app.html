<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToxGuard –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</title>
    <style>
        
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 750px;
            margin: auto;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            
        }
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #results {
            margin-top: 25px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #e9ecef;
        }
        .toxic {
            color: white;
            background-color: #dc3545;
            padding: 5px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        .normal {
            color: white;
            background-color: #28a745;
            padding: 5px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        #explanation_output {
            margin-top: 15px;
            border: 1px dashed #007bff;
            padding: 15px;
            border-radius: 4px;
            line-height: 1.8;
        }
        .dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }
        .dark-mode .container {
            background: #1f1f1f;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }
        .dark-mode textarea {
            background-color: #2c2c2c;
            border-color: #555;
            color: #e0e0e0;
        }
        .dark-mode button {
            background-color: #0088cc;
        }
        .dark-mode #results {
            background-color: #2c2c2c;
            border-color: #555;
        }
    </style>
</head>
<body>
    <body>
    <div class="container">
        <h2>ü§ñ ToxGuard –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—Å—Ç–∞</h2>
        <button id="theme_toggle" onclick="toggleTheme()" 
            style="float: right; padding: 5px 10px; margin-top: -5px; font-size: 14px;">
            –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Ç—ë–º–Ω—É—é
        </button>
        <label for="text_input">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:</label>
        <textarea id="text_input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>

        <div style="margin-bottom: 20px;">
            <label for="threshold_input">–ü–æ—Ä–æ–≥ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏ (0.0 - 1.0):</label>
            <input type="number" id="threshold_input" min="0.0" max="1.0" step="0.01" value="0.6" style="width: 80px; padding: 5px;">
        </div>
        
        <div id="results">
            <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</strong>
            <p id="status_output">–û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞...</p>

            <div id="confidence_graphs"></div> 

            <h4 style="margin-top: 20px;">üîé –û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è:</h4>
            
            <select id="explain_class" style="padding: 5px; margin-right: 10px;">
                <option value="" disabled selected>–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–∫—Å—Ç</option>
            </select>
            <button id="explain_button" onclick="requestExplanation()" disabled>–ü–æ–ª—É—á–∏—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ</button>
            
            <div id="explanation_output">
                –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É. (–ö—Ä–∞—Å–Ω—ã–π = –∑–∞ –∫–ª–∞—Å—Å, –°–∏–Ω–∏–π = –ø—Ä–æ—Ç–∏–≤)
            </div>
        </div>
    </div>

    <script>
        // –ê–î–†–ï–°–ê API
        const API_URL = 'http://127.0.0.1:8000/api/moderate';
        const API_EXPLAIN_URL = 'http://127.0.0.1:8000/api/explain';
        const ALL_LABELS = ['NORMAL', 'INSULT', 'THREAT', 'OBSCENITY'];

        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }
                timeoutId = setTimeout(() => {
                    func.apply(null, args);
                }, delay);
            };
        };


        // –§–£–ù–ö–¶–ò–Ø 1: –ú–û–î–ï–†–ê–¶–ò–Ø –ò –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –ì–†–ê–§–ò–ö–û–í
        async function moderateText() {
            const textInput = document.getElementById('text_input');
            const statusOutput = document.getElementById('status_output');
            const confidenceGraphs = document.getElementById('confidence_graphs');
            const thresholdInput = document.getElementById('threshold_input');

            const text = textInput.value.trim();
            const threshold = parseFloat(thresholdInput.value) || 0.6;
            
            if (!text) {
                statusOutput.innerHTML = "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç!";
                return;
            }

            statusOutput.innerHTML = "–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...";
            confidenceGraphs.innerHTML = '';
            document.getElementById('explanation_output').innerHTML = "–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É.";
            document.getElementById('explain_button').disabled = true;

            try {
                // –ó–∞–ø—Ä–æ—Å –Ω–∞ /api/moderate
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });

                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
                }

                const result = await response.json();
                
                // --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–ø—Ü–∏–π –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è (XAI) ---
                const explainClassSelect = document.getElementById('explain_class');
                explainClassSelect.innerHTML = '';
                document.getElementById('explain_button').disabled = false;
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∞—Å—Å—ã –ø–æ —É–±—ã–≤–∞–Ω–∏—é —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
                const sortedLabels = Object.entries(result.confidence)
                                         .sort(([, a], [, b]) => b - a)
                                         .map(([label]) => label);

                sortedLabels.forEach(label => {
                    const option = document.createElement('option');
                    option.value = label;
                    option.textContent = label + ` (${(result.confidence[label] * 100).toFixed(1)}%)`;
                    explainClassSelect.appendChild(option);
                });

                // --- –õ–æ–≥–∏–∫–∞ –ø–æ—Ä–æ–≥–∞ ---
                let isToxic = false;
                for (const label of ALL_LABELS) {
                    if (label !== 'NORMAL' && result.confidence[label] >= threshold) {
                        isToxic = true;
                        break; 
                    }
                }

                // --- –í—ã–≤–æ–¥ —Å—Ç–∞—Ç—É—Å–∞ ---
                let toxicityStatus = '';
                if (isToxic) {
                    toxicityStatus = `<span class="toxic">‚ùå –¢–û–ö–°–ò–ß–ù–û–°–¢–¨ –û–ë–ù–ê–†–£–ñ–ï–ù–ê! (–ü–æ—Ä–æ–≥: ${threshold})</span>`;
                } else {
                    toxicityStatus = `<span class="normal">‚úÖ –¢–ï–ö–°–¢ –ù–û–†–ú–ê–õ–¨–ù–´–ô. (–ü–æ—Ä–æ–≥: ${threshold})</span>`;
                }
                statusOutput.innerHTML = toxicityStatus;

                // --- –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–≤ ---
                let graphHTML = '<h4>–£—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏:</h4>';
                
                for (const [label, score] of Object.entries(result.confidence)) {
                    const percentage = (score * 100).toFixed(2);
                    const color = label === 'NORMAL' ? '#28a745' : '#dc3545'; // –ó–µ–ª–µ–Ω—ã–π –∏–ª–∏ –ö—Ä–∞—Å–Ω—ã–π

                    graphHTML += `
                        <div style="margin-bottom: 10px;">
                            <strong>${label}:</strong> ${percentage}%
                            <div style="background-color: #ddd; border-radius: 4px; height: 20px; overflow: hidden;">
                                <div style="width: ${percentage}%; background-color: ${color}; height: 100%; text-align: right; color: white; line-height: 20px;">
                                    &nbsp;
                                </div>
                            </div>
                        </div>
                    `;
                }
                confidenceGraphs.innerHTML = graphHTML;

            } catch (error) {
                statusOutput.innerHTML = `–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ API. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä Uvicorn –∑–∞–ø—É—â–µ–Ω.`;
                confidenceGraphs.innerHTML = `–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: ${error.message}`;
                console.error("API Error:", error);
            } finally {
                pass
            }
        }
        

        // –§–£–ù–ö–¶–ò–Ø 2: –ó–ê–ü–†–û–° –û–ë–™–Ø–°–ù–ï–ù–ò–Ø (XAI)
        async function requestExplanation() {
            const text = document.getElementById('text_input').value.trim();
            const targetClass = document.getElementById('explain_class').value;
            const explainButton = document.getElementById('explain_button');
            const explanationOutput = document.getElementById('explanation_output');
            
            explainButton.disabled = true;
            explanationOutput.innerHTML = "–†–∞—Å—á–µ—Ç –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏ —Å–ª–æ–≤ (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥)...";

            try {
                // –ó–∞–ø—Ä–æ—Å –Ω–∞ /api/explain
                const response = await fetch(API_EXPLAIN_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        text: text, 
                        target_class: targetClass 
                    })
                });

                const result = await response.json();
                
                if (result.error) {
                    explanationOutput.innerHTML = `–û—à–∏–±–∫–∞ API: ${result.error}`;
                } else {
                    displayExplanation(result.explanation);
                }

            } catch (error) {
                explanationOutput.innerHTML = `–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API /explain: ${error.message}`;
                console.error("Explain API Error:", error);
            } finally {
                explainButton.disabled = false;
            }
        }
        

        // –§–£–ù–ö–¶–ò–Ø 3: –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –¶–í–ï–¢–ù–û–ì–û –¢–ï–ö–°–¢–ê
        function displayExplanation(scores) {
            const explanationOutput = document.getElementById('explanation_output');
            let coloredHtml = '';
            
            // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –≤–µ—Å, —á—Ç–æ–±—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å —Ü–≤–µ—Ç–∞
            const maxAbsScore = Math.max(...scores.map(s => Math.abs(s.score)));

            scores.forEach(item => {
                const normalizedScore = Math.abs(item.score / maxAbsScore);
                const alpha = normalizedScore; 

                let color;
                // –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –≤–µ—Å (—Å–ª–æ–≤–æ –ü–û–î–¢–í–ï–†–ñ–î–ê–ï–¢ –∫–ª–∞—Å—Å) -> –ö—Ä–∞—Å–Ω—ã–π
                if (item.score > 0) {
                    color = `rgba(255, 0, 0, ${alpha})`;
                } 
                // –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –≤–µ—Å (—Å–ª–æ–≤–æ –ü–†–û–¢–ò–í–û–î–ï–ô–°–¢–í–£–ï–¢ –∫–ª–∞—Å—Å—É) -> –°–∏–Ω–∏–π
                else {
                    color = `rgba(0, 0, 255, ${alpha})`;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω —Å —Ñ–æ–Ω–æ–º (–∏—Å–ø–æ–ª—å–∑—É–µ–º <mark> –¥–ª—è –ª—É—á—à–µ–π —Å–µ–º–∞–Ω—Ç–∏–∫–∏, –Ω–æ <span> —Ç–æ–∂–µ –û–ö)
                coloredHtml += `<span style="background-color: ${color}; padding: 2px 0; border-radius: 2px; margin-right: 3px; display: inline-block;">${item.word}</span> `;
            });

            explanationOutput.innerHTML = coloredHtml;
        }

        // --- –õ–æ–≥–∏–∫–∞ –¢–Å–ú–ù–û–ô –¢–ï–ú–´ ---
        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('dark-mode');
            const isDarkMode = body.classList.contains('dark-mode');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
            document.getElementById('theme_toggle').textContent = 
                isDarkMode ? '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Å–≤–µ—Ç–ª—É—é' : '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Ç—ë–º–Ω—É—é';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            const textInput = document.getElementById('text_input');
            const toggleButton = document.getElementById('theme_toggle');

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Ç–µ–º—ã
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                toggleButton.textContent = '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Å–≤–µ—Ç–ª—É—é';
            } else {
                toggleButton.textContent = '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Ç—ë–º–Ω—É—é';
            }

            // –ü—Ä–∏–≤—è–∑–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∫–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è (Real-time Scoring)
            const debouncedModerate = debounce(moderateText, 750); 
            
            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∑–∞–ø—É—Å–∫ moderateText –∫ —Å–æ–±—ã—Ç–∏—é –≤–≤–æ–¥–∞ (keyup)
            textInput.addEventListener('keyup', debouncedModerate);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –µ—Å–ª–∏ –≤ –ø–æ–ª–µ —á—Ç–æ-—Ç–æ –µ—Å—Ç—å
            if (textInput.value.trim()) {
                moderateText();
            }
        });

    </script>
</body>
</html>